### 磁盘结构

##### 磁盘、磁道、扇区

磁盘表面有有一些磁性物质组成，可以用这些磁性物质来记录二进制数据

磁盘盘面被划分为一个个磁道。这样一个“圈”就是一个磁道。

一个磁道又被划分成一个个扇区，每个扇区就是一个“磁盘块”，每个扇区存放的数据量相同（如1KB）

最内侧磁道上的扇区面积最小，因此数据密度最大



##### 磁盘中读/写数据

需要把磁头移动到想要读/写的扇区所在的磁道

磁盘会转起来，让目标扇区从磁头下面划过，才能完成对扇区的读/写操作



##### 盘面、柱面

0号、1号、2号、3号盘面，每个盘面对应一个磁头，一个盘片可能会有两个盘面。

所有磁头都是连在同一个磁臂上的，因此所有磁头只能“共进退”。

所有盘面中相对位置相同的磁到组成柱面。



##### 磁盘物理地址

可以用(<span style="color:red">柱面号、盘面号、扇区号</span> )三元组来定位任意一个“磁盘块”，在“文件物理结构”小节中，提到的文件数据存放在外存中的几号块，这个几号块就可以转换成（柱面号、盘面号、扇区号）的地址形式。

可根据地址读取一个“块”

①根据“柱面号”移动磁臂，让磁头指向制定柱面；

②激活指定盘面对应的磁头

③在磁盘旋转过程中，指定扇区会从磁头下面划过，这样就完成了对指定扇区的读/写



##### 磁盘分类

磁头：

磁头可以移动的称为<span style="color:red">活动头磁盘</span> 。磁臂可以来回伸缩带动磁头定位磁道

磁头不可移动的称为<span style="color:red">固定头磁盘</span> ，这种磁盘中每个磁道有一个磁头



盘片：

盘片可以更换称为<span style="color:red">可换盘磁盘</span> 

盘片不可更换称为<span style="color:red">固定盘磁盘</span> 



### 磁盘调度算法

##### 磁盘读/写操作时间

一次磁盘读/写操作需要的时间

 <span style="color:red"> 寻找时间（寻道时间)Ts</span>：在读/写磁盘前，将磁头移动到指定磁道所花时间。

① <span style="color:red">启动磁头臂</span>是需要时间的，假设耗时为s

② <span style="color:red">移动磁头臂</span>也是需要时间的，假设磁头匀速移动，每跨越一个磁道耗时为m，总共要跨越n条磁道，则 => 

Ts = s + m*n

现如今市面上硬盘移动一个磁道大约需要0.2ms，磁臂启动时间约为2ms。

 <span style="color:red"> 延迟时间Tr</span>：通过旋转磁盘，将磁头定位到目标扇区所需要的时间，设磁盘转速为r（单位：转/秒，转/分），则平均所需的延迟时间Tr = (1/2)*(1/r) = 1/2r

1/r就是转一圈所需要的时间，找到目标扇区平均需要转半圈，因此需要x1/2

磁盘的典型转速为5400转/分，或7200转/分

 <span style="color:red">传输时间Tt</span>：从磁盘读出或向磁盘写入数据所经历的时间，假设转速为r，此次读/写字节数为b，每个磁道上的字节数为N。则：传输时间Tt = (1/r) * (b/N) = b/rN

每个磁道要可存N个字节的数据，因此需要b/N个磁道才能存储，读写一个磁道刚好需要转一圈所需的时间1/r



一次磁盘读写操作所需要的时间Ta = Ts + Tr  + Tt = Ts + 1/2r + b/rN

延迟时间、传输时间都与磁盘转速有关，且为线性相关。而转速属于软件固有属性，因此操作系统无法优化延迟时间和传输时间。操作系统磁盘调度算法，磁盘调度算法的不同会影响<span style="color:red">寻找时间的长短</span> 



##### 先来先服务（FCFS）

根据进程请求访问磁盘的先后顺序进行调度

假设磁头的初始位置在100号磁道上，有多个进程先后陆续请求访问55、58、39、18、90、160、150、38、184号磁道，根据FCFS规则，按照请求到达的顺序，磁头依次移动到55、58、39、18、90、160、150、38、184号磁道。

磁头总共移动了45 + 3 + 19 + 21 + 72 + 70 + 10 + 112 +146 = 498个磁道

响应一个请求平均需要移动 498/9 = 55.3 个磁道（平均寻找长度）

优点：很公平，先来的先服务，请求磁道比较集中时，算法性能比较不错

缺点：有大量进程竞争磁盘，请求访问的磁道很分散，则FCFS在性能上很差（近似于随机调度算法），寻道时间长



##### 最短寻找时间优先（SSTF）

SSTF算法会优先处理磁道与当前磁头最近的磁道。可以保证每次寻道的时间最短，但不能保证总的寻道时间最短。（其实就是贪心算法思想，只选择眼前最优，但总体未必最优）

假设磁头的初始位置在100号磁道上，有多个进程先后陆续请求访问55、58、39、18、90、160、150、38、184号磁道，根据SSTF规则，磁头依次移动道90、58、55、39、38、18、150、160、184

磁头总共移动了（100 - 18 ）+（184  - 18） = 248个磁道

响应一个请求平均需要移动 248/9 = 27.5 个磁道（平均寻找长度）

优点：性能好，平均寻道时间短

缺点：<span style="color:red">可能产生“饥饿”</span> 现象

Eg：如果磁头处理18号磁道访问请求时又来了一个38号磁道的访问请求，处理38号访问请求时又来了18号请求，后续时源源不断的18号磁道请求，150、160、184磁道请求永远得不到满足，从而产生饥饿现象。

产生饥饿的原因在于，磁头在一个小区域内来回移动。



##### 扫描算法（SCAN）

SSTF算法产生饥饿的原因：磁头在一个小区域内来回移动。为了防止这个问题，扫描算法规定：<span style="color:red">只有磁头移动到最外侧磁道时才能往内移动，移动到最内侧磁道时才能往外移动</span> ，这就是<span style="color:red">扫描算法（SCAN）</span> 算法思想。由于磁头移动的方式很像电梯，因此也叫<span style="color:red">电梯算法</span> 。

假设磁盘磁道0～200号，磁头的初始位置在100号磁道上，且<span style="color:red">此时磁头正在往磁道增大的方向移动</span> ，有多个进程先后陆续请求访问55、58、39、18、90、160、150、38、184号磁道。

​															------------>

0、18、38、39、55、58、90、｜100｜、150、160、184、200

100 -- 200、200 - 18

磁头总共移动了（200 - 100）+（200  - 18） = 282个磁道

响应一个请求平均需要移动 248/9 = 31.3 个磁道（平均寻找长度）

优点：性能好，平均寻道时间短，<span style="color:red">不会产生“饥饿”</span>现象

缺点：①只有达到最边上的磁道才能改变磁头移动方向，事实上，磁头移动到184号磁道访问请求后就不需要再往右移动磁头了。②对于各个位置磁道的响应频率不平均（如，假设此时磁头正在往右移动，且刚处理过90号磁道，那么下次处理90号磁道的请求就需要移动很长一段距离；而响应184号磁道的请求后，很快又再次可以响应184号磁道）③

① LOOK 调度算法

扫描算法只有达到最边上的磁道才能改变磁头移动方向，事实上，磁头移动到184号磁道访问请求后就不需要再往右移动磁头了。<span style="color:red">LOOK 调度算法</span> 就是为了解决这个问题。<span style="color:red">如果磁头在移动方向上已经没有别的请求，就可以立即改变磁头方向</span>。（边移动边观察，因此叫LOOK） 

优点：比SCAN算法比起来，不需要每次移动到最外侧/最内侧才改变磁头方向，使得寻道时间进一步缩短。

② 循环扫描算法（C-SCAN）

解决SCAN算法对于各个位置磁道的响应频率不平均问题



##### 循环扫描算法（C-SCAN）

规定只有磁头朝某个特定方向移动时才处理磁道访问请求，而<span style="color:red">返回时直接快速移动至起始端而不处理任何请求</span> 

假设磁盘磁道0～200号，磁头的初始位置在100号磁道上，且<span style="color:red">此时磁头正在往磁道增大的方向移动</span> ，有多个进程先后陆续请求访问55、58、39、18、90、160、150、38、184号磁道。

​															------------>

0、18、38、39、55、58、90、｜100｜、150、160、184、200

｜<-------------------------------------------------------------------------------------------------｜

只有到了最边上的磁道才改变磁头移动方向，磁头返回途中不处理任何请求

磁头总共移动了（200 - 100）+（200 - 0）+（90  - 0） = 190个磁道

响应一个请求平均需要移动 390/9 = 43.0 个磁道（平均寻找长度）

优点：比起SCAN算法来，对于各个位置磁道的响应频率很平均

缺点：只有达到最边上的磁道才能改变磁头移动方向，事实上，磁头移动到184号磁道访问请求后就不需要再往右移动磁头了，并且磁头返回时，只需要返回到18号磁道即可，不需要返回到最边缘的磁道。另外比起SCAN算法，平均寻道时间更长。

① C-LOOK算法

如果磁头移动的方向上没有磁道请求访问，就可以立即让磁头返回，并且磁头只需要返回到有磁道访问请求的位置即可。

【注】题目中没无特别说明时，SCAN算法为LOOK算法，C-SCAN算法为C-LOOK算法



### 减少磁盘延迟时间

将目标扇区转到磁头下面所花的时间

磁头读取一块扇区内容后，需要一小段时间处理，而盘片又在不停地旋转，因此相邻排列扇区读取时也不会连续读取，需要磁盘继续旋转，才能读入下一个扇区。

结论：磁头读入一个扇区数据后需要一小段时间处理，如果逻辑上相邻的扇区物理上也相邻。则读入几个连续的逻辑扇区，可能需要很长的延迟时间。



##### 交替编号

减少磁盘延迟时间的方法：交替编号

采用交替编号策略，即逻辑上相邻的扇区物理上有一定间隔，可以使连续的逻辑扇区所需要的延迟时间更小



磁盘地址结构设计

磁盘的物理地址是（柱面号，盘面号，扇区号）而不是（盘面号、柱面号、扇区号）why？

Eg：某磁盘有8个柱面/磁道（最内侧柱面/磁道号为0），4个盘面8个扇区。则可用3个二进制位表示柱面，2个二进制位表示盘面，3个二进制位表示扇区。

①若物理地址为<span style="color:red">盘面号、柱面号、扇区号</span> ，且需要连续读取物理地址（00 000 000）～ (00 001 111)

扇区编排是交替编号的：04152637

（00 000 000）～ (00 000 111) 转两圈可读完

之后再读取物理地址相邻的去区域，即

（00 001 000）～ (00 001 111)，<span style="color:red"> 需要启动磁臂，将磁头移动到下一个磁道</span>。

②若物理地址为<span style="color:red">柱面号，盘面号，扇区号</span> ，且需要连续读取物理地址（000 00 000）～ (000 01 111)

扇区编排是交替编号的：04152637

（00 000 000）～ (00 000 111) 转两圈可读完

之后再读取物理地址相邻的去区域，即

（00 001 000）～ (00 001 111)，<span style="color:red">由于柱面和磁道号相同，只是盘号不同，因此不需要移动磁头臂。只需要激活相邻盘面磁头即可</span> 。

=> 答：读取地址连续的磁盘块时，采用（柱面号，盘面号，扇区号）的地址结构可以减少磁头移动消耗的时间。



##### 错位命名

减少磁盘延迟时间的方法：错位命名

不采用错位命名

方案一：若相邻盘面相对位置相同扇区编号相同

（000 00 111）～ (000 01 000) -- 读完第一个盘面后，需要短暂的时间处理，不能理解读取下一个盘面的扇区(000 01 000)，也就是第一次滑过一号盘面磁头下方时并不能读取数据，只能再等该扇区再次滑过磁头。

【注】所有盘面都是一起连轴转



### 磁盘的管理

##### 磁盘初始化

Step One：进行<span style="color:red">低级格式化（物理格式化），将磁盘的各个磁道划分扇区</span> ，一个扇区通常可以分为头、数据区域（512B大小）、尾三个部分组成。管理扇区的数据结构一般放在头/尾两个部分，包括扇区校验码（奇偶校验、CRC循环冗余校验）校验码用于校验扇区中数据是否发生错误

Step Two：将磁盘分区，每个分区由若干柱面组成（如C盘、D盘、E盘）

Step Three：进行<span style="color:red">逻辑格式化</span> ，创建文件系统，创建文件系统的根目录，初始化存储空间管理所用的数据结构（如位示图、空闲分区表）



##### 引导块

计算机开机启动时需要进行一系列初始化工作，这些初始化工作通过执行<span style="color:red">初始化程序（自举程序）完成的</span> 。初始化CPU、内存、寄存器等。

初始化程序可以放在ROM（只读存储器)中。ROM中的数据在出厂时就写入了，并且<span style="color:red">以后不能再修改</span> 。

【注】ROM一般在出厂时就集成在主板上



初始化程序（自举程序）放在ROM中存在什么问题 ？

万一需要更新自举程序，将会很不方便，因为ROM中数据无法修改，如何解决 ?

ROM中只存放很小的“自举装入程序”，<span style="color:red">完整的自举程序会存放在磁盘的启动块（即以引导块/启动分区）上，启动块位于磁盘的固定位置。</span> 

开机时计算机先运行自举装入程序，通过该程序找到引导块，并将完整的自举程序读入内存，完成初始化

拥有启动分区的磁盘为<span style="color:red">启动磁盘或系统磁盘</span> 



##### 坏块的管理

坏了无法正常使用的扇区 = 坏块，属于硬件故障，操作系统是无法修复的。应该将坏块标记出来，以免错误地使用到坏块。

对于简单的磁盘，可以在逻辑格式化时（建立文件系统时）对整个磁盘进行坏块检查，表面哪些扇区是坏扇区，比如在FAT（文件分配表）表上标明（在这种方式中，<span style="color:red">坏块对操作系统不透明（操作系统可知）</span> ）

对于复杂的磁盘系统，磁盘控制器（磁盘设备内部的一个硬件部件）会维护一个坏块链表。

在磁盘出厂前进行低级格式化（物理格式化）就将坏块链进行初始化。

磁盘控制器会保留一些“备用扇区”，用于替换坏块。这种方案称为<span style="color:red">扇区备用</span> ，且这种处理方式中，<span style="color:red">坏块对操作系统透明（操作系统不可知）</span> 